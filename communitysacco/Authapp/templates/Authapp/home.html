{% extends 'main.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
  {% if user.is_authenticated %}
  <div class="content-panel p-4 mb-4">
    <h2 class="section-title mb-1">Member Dashboard</h2>
    <p class="mb-0">Welcome, <strong>{{ user.username }}</strong>. Track your sacco progress from one place.</p>
  </div>

  <div class="row g-3">
    <div class="col-lg-4">
      <div class="content-panel p-3 h-100">
        <h5 class="section-title">Loan Status</h5>
        <p class="kpi-value">{{ loan_status }}</p>
        <p class="kpi-label">Latest loan application status.</p>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="content-panel p-3 h-100">
        <h5 class="section-title">Savings Amount</h5>
        <p class="kpi-value">{{ total_saved }}</p>
        <p class="kpi-label">Total savings deposited so far.</p>
      </div>
    </div>
    <div class="col-lg-4">
      <div class="content-panel p-3 h-100">
        <h5 class="section-title">Pending Transactions</h5>
        <p class="kpi-value">{{ pending_transactions }}</p>
        <p class="kpi-label">Transactions awaiting processing.</p>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="content-panel p-3 h-100">
        <h5 class="section-title">My Details</h5>
        <p class="mb-1"><strong>Username:</strong> {{ user.username }}</p>
        <p class="mb-1"><strong>Email:</strong> {{ user.email|default:"Not provided" }}</p>
        <p class="mb-0"><strong>Role:</strong> {% if user.is_staff %}Admin{% else %}User{% endif %}</p>
      </div>
    </div>
    <div class="col-lg-6">
      <div class="content-panel p-3 h-100">
        <h5 class="section-title">Loan Requirements</h5>
        <p class="mb-2">Before applying for a loan, prepare:</p>
        <ul class="mb-0">
          <li>Financial statements for the last 6 months</li>
          <li>Picture or copy of your national ID</li>
        </ul>
      </div>
    </div>
    <div class="col-lg-12">
      <div class="content-panel p-3 h-100">
        <h5 class="section-title">Loan Limit</h5>
        <p class="kpi-value">{{ loan_limit }}</p>
        <p class="kpi-label">Default is None until an admin sets it.</p>
      </div>
    </div>
    <div class="col-lg-12">
      <div class="content-panel p-3 h-100">
        <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
          <h5 class="section-title mb-0">Navigation Assistant</h5>
          <small>Ask simple questions about using the app.</small>
        </div>
        <div class="mb-2">
          <input type="text" id="chatbotQuestion" class="form-control" placeholder="Example: how do I repay an approved loan?">
        </div>
        <div class="d-flex gap-2 mb-3">
          <button id="chatbotAskBtn" type="button" class="btn btn-success">Ask</button>
          <a href="{% url 'app-values' %}" class="btn btn-outline-light">Read App Values</a>
        </div>
        <div id="chatbotAnswer" class="p-3 rounded" style="background: rgba(255,255,255,0.1); min-height: 70px;">
          Ask a question to get help navigating savings, loans, payments, and transactions.
        </div>
      </div>
    </div>
  </div>
  {% else %}
  <div class="content-panel p-4 text-center">
    <h2 class="section-title">Welcome to Community Sacco</h2>
    <p class="mb-3">Login or register to access your member dashboard.</p>
    <a href="{% url 'login' %}" class="btn btn-warning me-2">Login</a>
    <a href="{% url 'register' %}" class="btn btn-outline-light">Register</a>
  </div>
  {% endif %}
</div>
<script>
  (function () {
    const questionInput = document.getElementById("chatbotQuestion");
    const askBtn = document.getElementById("chatbotAskBtn");
    const answerBox = document.getElementById("chatbotAnswer");
    if (!questionInput || !askBtn || !answerBox) return;

    function getCookie(name) {
      const cookieValue = document.cookie
        .split(";")
        .map(function (c) { return c.trim(); })
        .find(function (c) { return c.startsWith(name + "="); });
      return cookieValue ? decodeURIComponent(cookieValue.split("=")[1]) : "";
    }

    askBtn.addEventListener("click", function () {
      const question = (questionInput.value || "").trim();
      if (!question) {
        answerBox.textContent = "Please type a question first.";
        return;
      }
      answerBox.textContent = "Checking...";
      fetch("{% url 'chatbot-assistant' %}", {
        method: "POST",
        headers: {
          "Content-Type": "application/x-www-form-urlencoded",
          "X-CSRFToken": getCookie("csrftoken")
        },
        body: "question=" + encodeURIComponent(question)
      })
      .then(function (response) { return response.json(); })
      .then(function (data) {
        answerBox.textContent = data.answer || "No answer available right now.";
      })
      .catch(function () {
        answerBox.textContent = "Assistant is unavailable right now. Please try again.";
      });
    });
  })();
</script>
{% endblock %}
